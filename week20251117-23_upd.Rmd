---
title: "Анализ фармакокинетики этанола исследования Yelland-2008"
author: "Alexey Gordeev, Anna Vronskaia"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(patchwork)
library(flextable)
```

## Настройка темы

```{r theme_set, echo=TRUE}
theme_custom <-
  theme(
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20, margin = margin(t = 15, unit = "pt")),
        axis.title.x = element_text(size = 24),
        axis.title.y = element_text(size = 24),
        panel.background = element_rect(fill = "white", colour = "white"),
        panel.grid = element_line(color = "gray85"),
        legend.text = element_text(size=20),
        legend.title = element_text(size=24),
        plot.title = element_text(size = 30, margin = margin(b = 10, unit = "pt")),
        plot.subtitle = element_text(size = 26, margin = margin(b = 15, unit = "pt"))
  )
standard_theme <- theme_bw() +
  theme(plot.title = element_text(size = 30, hjust = 0.5),
    plot.subtitle = element_text(size = 25, hjust = 0.5),
    plot.caption = element_text(size = 20),
    axis.title = element_text(size = 25),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_text(size = 20),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 22),
    strip.text = element_text(size = 22))
theme_set(standard_theme)
set_flextable_defaults(table.layout = "autofit")
```

# Загрузка и подготовка датасета

```{r upload, echo=TRUE}
data_Yelland <- read.csv("data/raw/Yelland-2008.csv")
data_Yelland <- data_Yelland %>% 
  mutate(across(c(subject_id, occasion), as.character))
str(data_Yelland)
```
# Графики индивидуальных кривых

```{r plot-conc-time, fig.width=24, fig.height=16, echo=FALSE, warning=FALSE, message=TRUE}
plot2 <- data_Yelland %>% 
  select(subject_id, conc_g_per_L, time_min, occasion) %>% 
  ggplot(aes(color = occasion)) +
  geom_line(aes(x = time_min, y = conc_g_per_L, group = occasion), linewidth = 2) +
  facet_wrap(subject_id~.)+
  scale_x_continuous(breaks = seq(0, 420, by = 50))+
  scale_y_continuous(breaks = seq(0, 1, by = 0.25))+
    labs(title = "Зависимость концентрации от времени", subtitle = "Индивидуальные кривые для каждого субъекта", x = "Время, мин", y = "Концентрация, г/л", color = "Визит")+
  theme_custom+
  theme(legend.position = "top")

plot2
```
```{r point_num, echo=TRUE}
# current_num <- 1
# for(i in 1:nrow(data_Yelland)) {
#   if(data_Yelland$time_min[i] == 0) {
#     current_num <- 1  # обнуляем счетчик
#   } else {
#     current_num <- current_num + 1
#   }
#   data_Yelland$point_id[i] <- current_num
# }
# 
# rm(i)
# rm(current_num)

# можно сделать то же самое с помощью row_number()
data_Yelland <- data_Yelland %>% 
  mutate(case_name = str_c(subject_id, "_",occasion))

data_Yelland <- data_Yelland %>%
  group_by(case_name) %>%
  mutate(point_id = row_number()) %>% 
  ungroup()
```

# Среднее и стандартное отклонение по всем субъектам (по номеру точки)

Время на точках усреднено

```{r plot-conc-time-avg-2, fig.width=16, fig.height=9, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
data_Yelland_mean_sd <- data_Yelland %>% 
  group_by(point_id) %>%
  summarise(conc_avg = mean(conc_g_per_L), conc_max = mean(conc_g_per_L) + sd(conc_g_per_L), conc_min = mean(conc_g_per_L) - sd(conc_g_per_L), time_min_avg = mean(time_min))

data_Yelland_mean_sd %>% 
  ggplot() +
  geom_line(aes(x = time_min_avg, y = conc_avg)) +
  geom_errorbar(aes(x = time_min_avg, ymin = conc_min, ymax = conc_max), width = 6, size=0.5) +
  scale_x_continuous(breaks = seq(0, 400, by = 50)) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.25)) +    
  labs(title = "Зависимость концентрации от времени", subtitle = "Mean ± SD", x = "Время, мин", y = "Концентрация, г/л") +
  theme_custom
```

# Расчет основных фармакокинетических параметров

```{r, message=FALSE, echo=FALSE, eval=TRUE}
pharma_fun <- function(conc, t, dose, k = 2) {
  # Моделирование для подсчёта beta, C0, Vd
  t_sample <- {{t}}[(first(which.max({{conc}})) + k):length({{t}})]
  conc_sample <- conc[(first(which.max({{conc}})) + k):length({{conc}})]
  dose <- first({{dose}})
  model <- lm({{conc_sample}} ~ {{t_sample}})
  Beta <- -as.numeric(model$coefficients[2])
  C_0 <- as.numeric(model$coefficients[1])
  V_d <- dose / C_0
  
  # Подсчёт AUC0-t
  
  # if (length({{t}}) < 2) AUC <- NA
  # if (anyNA({{t}}) | anyNA({{conc}})) AUC <- NaN
  t0 = {{t}}[-length({{t}})]
  t1 = {{t}}[-1]
  c0 = {{conc}}[-length({{conc}})]
  c1 = {{conc}}[-1]
  AUC = sum(((c0 + c1)/2)*(t1 - t0))
  
  # Подсчёт Cmax
  cmax <- max(conc)
  
  # Подсчёт Tmax
  tmax <- t[first(which.max(conc))]
  
  abs_rate <- cmax/tmax
  
  return(list(Beta = Beta,
              C_0 = C_0,
              V_d = V_d,
              AUC = AUC,
              Cmax = cmax,
              Tmax = tmax,
              Abs_rate = abs_rate))
}

stat_ph <- list(
        "Среднее" = ~mean(., na.rm = TRUE) %>% round(4),
        "Медиана" = ~median(., na.rm = TRUE)%>% round(4),
        "Стандартное отклонение"   = ~sd(., na.rm = TRUE) %>% round(4),
        "Коэффициент вариации (CV), %" = ~round((sd(., na.rm = TRUE))/(mean(., na.rm = TRUE)) * 100, 2)
        )



pharmacokinetics_data <- data_Yelland %>% 
  arrange(time_min) %>% 
  nest(.by = case_name, .key = "case_data") %>% 
  mutate(pharma = purrr::map(case_data,
                            ~pharma_fun(.$conc_g_per_L,
                                        .$time_min,
                                        .$dose_g_per_kg))) %>% 
  unnest_wider(col = pharma) %>% 
  select(-case_data) %>% 
  separate(case_name,
           into = c("subject_id", "occasion"),
           sep = "_",
           remove = FALSE)

```

## Рассчитаем центральную тенденцию и разброс
```{r pharm-parameters-stat, echo=TRUE}
pharmacokinetics_data_table <- pharmacokinetics_data %>% 
  mutate(Beta = Beta * 60) %>%  # перевожу в г/л в час
  rename(`β, г/л в час` = Beta,
         `C0, г/л` = C_0,
         `Vd, л/кг` = V_d,
         `AUC0-t, г*мин/л` = AUC,
         `Cmax, г/л` = Cmax,
         `Tmax, мин` = Tmax,
         `Absortion rate, г/л в час` = Abs_rate)
pharmacokinetics_data_table %>%
  select(-subject_id, -occasion) %>% 
  pivot_longer(!case_name,
               names_to = "Показатель",
               values_to = "Значение") %>% 
  group_by(`Показатель`) %>% 
  summarise(across(`Значение`, stat_ph, .names = "{.fn}")) %>% 
  ungroup() %>% 
  flextable() %>%
  theme_box %>% 
  fontsize(size=9) %>% 
  add_header_row(values  = "Описательные статистики фармакокинетических показателей", colwidths = 5)
```

# Визуализируем выборочные распределения всех параметров из предыдущего пункта 

```{r, fig.height=17, fig.width=20, dpi=300}
hist_fn <- function(data, col) {
  
  ggplot(data, aes(x = {{col}})) +
  geom_boxplot(
    alpha = 0.5,
  # width = width,
    linewidth = 1.5,
    outlier.size = 2,
  ) +
  geom_histogram(
    fill = "midnightblue",
    alpha = 0.5,
    colour = "black",
    bins = 20
  ) +
    scale_y_continuous(breaks = seq(1, 100, by = 1)) +
    geom_vline(aes(xintercept = mean({{col}}, na.rm = T)),
               color = "darkred",
               linetype = 2,
               linewidth = 2) +
  labs(# title = rlang::englue("{{col}}"),
       y = "Количество, n",
       x = rlang::englue("{{col}}")) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title = element_text(size = 25),
        axis.text.y = element_text(size = 23),
        axis.text.x = element_text(size = 23),
        legend.title = element_text(size = 23),
        legend.text = element_text(size = 23))
}

pharmacokinetics_data_for_plots <- pharmacokinetics_data_table %>% 
  group_by(subject_id) %>% 
  summarise(across(where(is.numeric), ~mean(.x))) %>% 
  ungroup() %>% 
  arrange(as.numeric(subject_id))

col_list <- pharmacokinetics_data_for_plots %>%
  select(-subject_id) %>%
  names() %>%
  syms()

hist_plots <- purrr::map(col_list,
    ~ hist_fn(pharmacokinetics_data_for_plots, !!.x))

wrap_plots(hist_plots, ncol = 2) +
  plot_annotation(title = "Гистограммы и боксплоты фарм. показателей",
                  theme = standard_theme)
```

# CVinter и CVintra

```{r}
ii_in_variability <- function(pharmacokinetics_parametr, subject_id, vis = 3) {
  
  mod <- lm(log({{pharmacokinetics_parametr}}) ~ factor({{subject_id}}))
  
  anova_mod <- anova(mod)
  
  SDb <- sqrt((anova_mod$`Mean Sq`[1] - anova_mod$`Mean Sq`[2])/vis)
  
  CVb <- sqrt(exp(SDb^2)-1) * 100
  
  SDw <- sqrt(anova_mod$`Mean Sq`[2])
  
  CVw <- sqrt(exp(SDw^2)-1) * 100
  
  b_perc <- SDb^2/(SDb^2+SDw^2) * 100
  
  w_perc <- SDw^2/(SDb^2+SDw^2) * 100
  
  return(tibble(
    SDb = round(SDb, 4),
    CVb = round(CVb, 0),
    b_perc = round(b_perc,0),
    SDw = round(SDw, 4),
    CVw = round(CVw, 0),
    w_perc = round(w_perc,0))
    )
}


pharmacokinetics_data_variance <- pharmacokinetics_data_table %>% 
  summarise(across(where(is.numeric), ~ii_in_variability(.x, subject_id))) %>% 
  pivot_longer(everything(),
               names_to = "Показатель",
               values_to = "variability") %>% 
  unnest_wider(variability)

pharmacokinetics_data_table <- pharmacokinetics_data_table %>%
  select(-subject_id, -occasion) %>% 
  pivot_longer(!case_name,
               names_to = "Показатель",
               values_to = "Значение") %>% 
  group_by(`Показатель`) %>% 
  summarise(across(`Значение`, stat_ph, .names = "{.fn}")) %>% 
  ungroup() %>%
  left_join(pharmacokinetics_data_variance)

pharmacokinetics_data_table %>% 
  flextable() %>%
  theme_box %>% 
  fontsize(size=9) %>% 
  add_header_row(values  = "Описательные статистики фармакокинетических показателей вместе с межсубъектной и внутрисубъектной вариабельностью", colwidths = 11)
```

# Визуализация отклонений от среднего по субъекту

```{r}
pharmacokinetics_data <- pharmacokinetics_data %>%
  mutate(Beta = Beta * 60) %>%
  rename(`β, г/л в час` = Beta,
         `C0, г/л` = C_0,
         `Vd, л/кг` = V_d,
         `AUC0-t, г*мин/л` = AUC,
         `Cmax, г/л` = Cmax,
         `Tmax, мин` = Tmax,
         `Absortion rate, г/л в час` = Abs_rate)
```

## β, г/л в час

```{r, fig.height=40, fig.width=17, dpi=300}
param_plot_fn <- function(data, col, occasion, subject_id) {
  
  data_upd <- data %>% 
    group_by({{subject_id}}) %>% 
    mutate(subj_mean = mean({{col}}, na.rm = TRUE)) %>% 
    ungroup()
  
  ggplot(data_upd, aes(x = {{col}})) +
  geom_hline(aes(yintercept = {{col}}),
             color = "purple3",
             linewidth = 2) +
  geom_hline(aes(yintercept = subj_mean),
               color = "forestgreen",
               linetype = 2,
               linewidth = 2) +
  labs(title = rlang::englue("{{col}}"),
       y = rlang::englue("{{col}}"),
       x = "") +
   facet_grid(rows = vars(as.numeric({{subject_id}})),
              cols = vars({{occasion}}),
              labeller = labeller(
                .rows = function(x) paste("Номер субъекта:", x),
                .cols = function(x) paste("Номер визита:", x)
      )
) +
    theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 35),
        axis.title = element_text(size = 30),
        axis.text.y = element_text(size = 30),
        axis.text.x = element_text(size = 30),
        strip.text = element_text(size = 24)
        )
}

param_plot_fn(pharmacokinetics_data, `β, г/л в час`, occasion, subject_id)
```

## C0, г/л

```{r, fig.height=40, fig.width=17, dpi=300}
param_plot_fn(pharmacokinetics_data, `C0, г/л`, occasion, subject_id)
```
## Объём распространения, л/кг

```{r, fig.height=40, fig.width=17, dpi=300}
param_plot_fn(pharmacokinetics_data, `Vd, л/кг`, occasion, subject_id)
```

## Площадь под кривой 0-t, г*мин/л

```{r, fig.height=40, fig.width=17, dpi=300}
param_plot_fn(pharmacokinetics_data, `AUC0-t, г*мин/л`, occasion, subject_id)
```

## Cmax, г/л

```{r, fig.height=40, fig.width=17, dpi=300}
param_plot_fn(pharmacokinetics_data, `Cmax, г/л`, occasion, subject_id)
```

## Tmax, мин

```{r, fig.height=40, fig.width=17, dpi=300}
param_plot_fn(pharmacokinetics_data, `Tmax, мин`, occasion, subject_id)
```

## Скорость абсорбции, г/л в час

```{r, fig.height=40, fig.width=17, dpi=300}
param_plot_fn(pharmacokinetics_data, `Absortion rate, г/л в час`, occasion, subject_id)
```