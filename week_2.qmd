---
title: "week_2"
format: html
---

```{r}
library(tidyverse)
library(readr)
library(skimr)
library(patchwork)
```

## Задачи

-   Загрузка датасета Ammon-1996 (у нас команда 1). 
  -   Сергей делает Occasion 1, Милана делает Occasion 2

-   (EDA) Визуализация кривых концентрация-время (спагетти-плот) В виде индивидуальных кривых (сравнение между occasion) В виде среднего +- стандартное отклонение для каждой временной точки

-   (EDA) Расчет основных ФК + визуализация распределений

-   Использование ANOVA для определения межсубъектной (Inter-individual) и внутрисубъектной (intra-individual/between subject/inter-occasion) вариабельности

-   Расчет CVinter и CVintra для каждого из ФК параметров, а также оценка вклада (в % от общей вариабельности) inter и intra компонент

-   Визуализация результатов (визуализация отклонений от среднего для каждого субъекта или любой другой вариант, который вам покажется информативным)

-   Интерпретация результатов и короткий отчет (в виде power point презентации или R markdown)

```{r}
Ammon_1996 <- read_csv("data/raw/Ammon-1996.csv")
Ammon_clean <- Ammon_1996 %>% 
  select(subject_id,
         occasion,
         dose_g_per_kg,
         time_min,
         conc_g_per_L)

theme_custom <- theme(
  axis.text = element_text(size = 20),
  axis.title = element_text(size = 25),
  plot.title = element_text(size = 30, hjust = 0.5),
  plot.subtitle = element_text(size = 20, hjust = 0.5),
  legend.title = element_text(size = 20),
  legend.text = element_text(size = 15),
  panel.background = element_rect(fill = "white"), 
  panel.grid = element_blank()
)
theme_set(theme_custom)
```

## Визуализация исходных данных

### Графики для каждого эксперимента
```{r occasion_spaghetti_vis, fig.width=20, fig.height=10}
occasion_1 <- Ammon_clean %>% 
  filter(occasion == 1) %>% 
  group_by(subject_id) %>% 
  ggplot()+
  geom_line(aes(x = time_min, y = conc_g_per_L, group = subject_id, colour = factor(subject_id))) +
  geom_point(aes(x = time_min, y = conc_g_per_L, colour = factor(subject_id)), size = 2) +
  scale_x_continuous(breaks = seq(0, 360, by = 30)) +
  labs(x = "Время, мин",
       y = "Концентрация г/л",
       title = "Occasion 1")+
  theme(legend.position = "none")

occasion_2 <- Ammon_clean %>% 
  filter(occasion == 2) %>% 
  group_by(subject_id) %>% 
  ggplot()+
  geom_line(aes(x = time_min, y = conc_g_per_L, group = subject_id, colour = factor(subject_id)))+
  geom_point(aes(x = time_min, y = conc_g_per_L, colour = factor(subject_id)), size = 2) +
  scale_x_continuous(breaks = seq(0, 360, by = 30)) +
    labs(x = "Время, мин",
       y = "Концентрация г/л",
       title = "Occasion 2") +
  theme(legend.position = "none")

occasion_1 | occasion_2
```

### Графики сравнения двух экспериментов для каждого субъекта

```{r subject_spaghetti_vis, fig.width=20, fig.height=10}
temp_1 <- ggplot(Ammon_clean) +
  labs(title = "Концентрация - время",
       y = "Концентрация, г/л")+
  theme(axis.text = element_text(size = 11),
        axis.title = element_text(size = 11),
        plot.title = element_text(size = 12, hjust = 0.5),
        legend.position = "none")

conc_time_func <- function(subID,
                      mapping = aes(x = time_min, y = conc_g_per_L, group = occasion, colour = occasion),
                          ...){
  conc_time <- Ammon_clean %>% 
    filter(subject_id == subID) %>% 
    geom_line(mapping = mapping)}

subjID = unique(Ammon_clean$subject_id)

conc_time <- map(subjID, 
                \(x) temp_1+
                  conc_time_func(subID=x)+
                  scale_x_continuous(name = paste0("#ID: ", x)))

wrap_plots(conc_time)
```

### Среднее и стандартное отклонение для каждого из экспериментов

```{r summary conc}
summ_ammon_1 <- Ammon_clean %>% 
  group_by(time_min) %>% 
  filter(occasion == 1) %>% 
  summarise(
    mean_conc = mean(conc_g_per_L, na.rm = TRUE),
    sd_conc   = sd(conc_g_per_L, na.rm = TRUE)
  )

summ_ammon_1

summ_ammon_2 <- Ammon_clean %>% 
  group_by(time_min) %>% 
  filter(occasion == 2) %>% 
  summarise(
    mean_conc = mean(conc_g_per_L, na.rm = TRUE),
    sd_conc   = sd(conc_g_per_L, na.rm = TRUE)
  )

summ_ammon_2
```

### Среднее и стандартное отклонение для каждого из экспериментов - график

```{r summary datatvis, fig.width=20, fig.height=10}


summ_1 <- ggplot(summ_ammon_1, aes(x = time_min, y = mean_conc)) +
  geom_line(color = "blue", size = 1) +
  geom_ribbon(aes(ymin = mean_conc - sd_conc,
                  ymax = mean_conc + sd_conc),
              alpha = 0.2, fill = "lightblue") +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(0, 360, by = 30)) +
  labs(x = "Время, мин",
       y = "Концентрация, г/л",
      subtitle = "Occasion 1") +
  scale_y_continuous(
    breaks = seq(0, 1, 0.05)
  ) 

summ_2 <- ggplot(summ_ammon_2, aes(x = time_min, y = mean_conc)) +
  geom_line(color = "blue", size = 1) +
  geom_ribbon(aes(ymin = mean_conc - sd_conc,
                  ymax = mean_conc + sd_conc),
              alpha = 0.2, fill = "lightblue") +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(0, 360, by = 30)) +
  labs(x = "Время, мин",
       y = "Концентрация, г/л",
      subtitle = "Occasion 2") +
  scale_y_continuous(
    breaks = seq(0, 1, 0.05)
  ) 


(summ_1 | summ_2) +
  plot_annotation(title = "Средняя концентрация ± SD" )
```

## Фармакокинетические параметры

### Расчет фармакокинетических параметров для каждого субъекта в исследовании

Для расчета используется линейная модель

```{r pk param}
AUC_calc <- function(time, conc) {
  AUC_value <- 0
  for (i in 1:(length(time) - 1)) {
    AUC_value <- AUC_value + 0.5 * (conc[i] + conc[i+1]) * (time[i+1] - time[i])
  }
  return(AUC_value)
}

Beta_LM_calc <- function(time, conc) {
  ok <- is.finite(time) & is.finite(conc) & conc > 0
  time <- time[ok]
  conc <- conc[ok]
  linear <- lm(conc ~ time) 
  cf <- coefficients(linear)[2] * (-60) 
  return(cf)
  }

C0_LM_calc <- function(time, conc) {
  ok <- is.finite(time) & is.finite(conc) & conc > 0
  time <- time[ok]
  conc <- conc[ok]
  linear <- lm(conc ~ time) 
  cf <- coefficients(linear)[1]
  return(cf)
  }

pk_params <- Ammon_clean %>% 
  group_by(subject_id,
           occasion) %>% 
  summarise(
    C_max = max(conc_g_per_L),
    T_max = time_min[which.max(conc_g_per_L)],
    AUC_linear = AUC_calc(time_min, conc_g_per_L),
    Beta_LM = Beta_LM_calc(tail(time_min, 4), tail(conc_g_per_L, 4)),
    C0_LM = C0_LM_calc(tail(time_min, 4), tail(conc_g_per_L, 4)),
    Dose = unique(dose_g_per_kg),
    Vd = Dose / C0_LM)

summary(pk_params)
  
```


### Центральная тенденция и меры размаха


```{r summary pk params}
cv <-  function(val, na.rm=TRUE) {
  sd(val, na.rm = na.rm)/mean(val, na.rm = na.rm) * 100
}

pk_params_summ <- pk_params %>% 
  pivot_longer(cols = everything(), names_to = "variable") %>% 
  group_by(variable) %>% 
  summarize(
    Mean = mean(value, na.rm = TRUE),
    Median = median(value, na.rm = TRUE),
    StDev = sd(value, na.rm = TRUE),
    CV = cv(value)
  )

pk_params_summ
```

### Распределение фармакокинетических параметров в исследовании

```{r vis_hist, fig.width=45, fig.height=16}
summ_oc_1 <- pk_params %>% 
  filter(occasion == 1) %>% 
  select(AUC_linear,
         Beta_LM,
         C0_LM,
         C_max,
         Vd) %>% 
  pivot_longer(cols = AUC_linear:Vd, names_to = "variable") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 20, fill = "#6E8B3D", colour = "grey33") +
  geom_boxplot(width = 0.5) +
  facet_wrap(~ variable, scales = "free") +
  labs(y = " ",
       x = " ")

summ_oc_2 <- pk_params %>% 
  filter(occasion == 2) %>% 
  select(AUC_linear,
         Beta_LM,
         C0_LM,
         C_max,
         Vd) %>% 
  pivot_longer(cols = AUC_linear:Vd, names_to = "variable") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 20, fill = "cadetblue4", colour = "grey33") +
  geom_boxplot(width = 0.5) +
  facet_wrap(~ variable, scales = "free") +
  labs(y = " ",
       x = " ")

summ_oc_1 | summ_oc_2
```


### ANOVA

```{r}

```

### CVInter, CVintra + визуализация результатов

```{r}

```



